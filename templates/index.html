<!DOCTYPE html>
<html lang="kr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <script src="{{ url_for('static', filename='js/index.js') }}" defer></script> -->
    <script src="{{ url_for('static', filename='js/jQuery.js') }}" ></script>
    <script defer>


// 지정한 html selector에 html content를 추가하는 함수
function add_element(selector, html_content)
{
    var prev_content = $(selector).html();
    $(selector).html(prev_content + html_content);
}


// Html 요소 생성을 도와주는 클래스
class HtmlElementGenerator {
    // htmlBase에는 기초가 될 html 코드를 작성합니다.
    constructor (htmlBase) {
        this.htmlBase = htmlBase;
        this.baseArgs = [];
    } 

    // 입력한 htmlBase에 baseArgs를 포매팅해 리턴하는 메소드
    getHtmlCode(baseArgs) {
        if (baseArgs === []) {
            return;
        }
        
        var to_return = this.htmlBase
        baseArgs.forEach((element, idx) => {
            to_return = to_return.replace("{" + idx + "}", String(element));
        });

        return to_return;
    }
}

class ElementList {
    constructor (selector, generator) {
        this.selector = selector;
        this.elements = [];
        this.generator = generator;
    }

    push (to_add) {
        this.elements.push(to_add);
    }

    remove (index) {
        this.elements.splice(index, 1);
    }

    removeAll () {
        this.elements = [];
    }

    render () {
        $(this.selector).html("");

        this.elements.forEach((e, i) => {
            var htmlCode = this.generator.getHtmlCode([i, e, i]);
            add_element(this.selector, htmlCode);
        });
    }

    getElements () {
        return this.elements;
    }

}

// [min, max]의 범위에서 무작위한 수를 리턴하는 함수
function random(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

// roles를 무작위로 names에 할당하는 함수
function assign_roles(names, roles)
{
    
    var used_idx = [];
    var shuffled = [];
    var result = new Map();

    for (var i = 0; i < names.length; i++) {
        var idx = random(0, roles.length - 1);
        
        while (used_idx.includes(idx))
        {
            idx = random(0, roles.length - 1);
        }

        shuffled.push(roles[idx]);
        used_idx.push(idx);
    }

    for (var i = 0; i < names.length; i++)
    {
        result.set(names[i], shuffled[i]);
    }

    return result;
}



const nameElementGenerator = new HtmlElementGenerator(
    '<div class="element" id="{0}">' + 
        '<p class="element_text">㏅ {1}</p><button class="element_button" onclick="(() => {names.remove({2}); names.render();})()">×</button>' + 
    '</div>'
);
const names = new ElementList("#home #main #name_div #elements_list", nameElementGenerator);
function add_name() {
    var to_add = $("#home #main #name_div input").val();

    if (to_add === '') {
        return;
    }
    names.push(to_add);
    names.render();
    $("#home #main #name_div input").val("");

}

const roleElementGenerator = new HtmlElementGenerator(
    '<div class="element" id="{0}">' + 
        '<p class="element_text">⒡ {1}</p><button class="element_button" onclick="(() => {roles.remove({2}); roles.render();})()">×</button>' + 
    '</div>'
);

const roles = new ElementList("#home #main #role_div #elements_list", roleElementGenerator);
function add_role() {
    var to_add = $("#home #main #role_div input").val();

    if (to_add === '') {
        return;
    }

    roles.push(to_add);
    roles.render();
    $("#home #main #role_div input").val("");
}

function resetAll() {
    names.removeAll();
    roles.removeAll();
    $("#home #main #name_div input").val("");
    $("#home #main #role_div input").val("");
    names.render();
    roles.render();
}

var isMainPage = true;


function changePage() {
    if (isMainPage) {
        // 메인페이지 > 결과페이지
        showResult();
        $("#home").attr("style", "display: none");
        $("#result").attr("style", "")
    } else {
        // 결과페이지 > 메인페이지
        $("#result_table").html("")
        $("#home").attr("style", "");
        $("#result").attr("style", "display: none")
    }

    isMainPage = !isMainPage;
}

function showResult() {
    var res = assign_roles(names.getElements(), roles.getElements());
    console.log(res.size);
    const tableGenerator = new HtmlElementGenerator(
        '<tr>' +
            '<td class="res_name">㏅ {0}</td>' +
            '<td class="res_blank">></td>' +
            '<td class="res_role">⒡ {1}</td>' +
        '</tr>'
    );


    res.forEach((val, key) => {
        add_element("#result_table", tableGenerator.getHtmlCode([key, val]));
    });
}


    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    <title>청소분담제 역할배정(β)</title>
</head>
<body>
    <!-- 메인 페이지 -->
    <div id="home" class="page_div">
        <div id="header" class="header">
            <h1>⊆ 이름과 역할을 설정하세요</h1>
        </div>
        <div id="main" class="main">
            <div id="name_div">
                <h3>이름</h3>
                <form onsubmit="return false;" class="add_form">
                    <input class="add_input" onkeypress="if(window.event.keyCode == 13){ add_name() }">
                </form>
                <button class="add_button" id="add" onclick="add_name()">+</button>
                <div id="elements_list" class="elements_list"></div>
            </div>
            <div id="role_div">
                <h3>역할</h3>
                <form onsubmit="return false;" class="add_form">
                    <input class="add_input" onkeypress="if(window.event.keyCode == 13){ add_role() }">
                </form>
                <button class="add_button" id="add" onclick="add_role()">+</button>
                <div id="elements_list" class="elements_list"></div>
            </div>
        </div>
        <div id="footer" class="footer">
            <div id="buttons_div" class="buttons_div">
                <button class="action_button _left" onclick="resetAll()">㎱ 초기화</button><button class="action_button _right" onclick="changePage()">다음</button>
            </div>
        </div>
    </div>
    <!-- 결과 페이지 -->
    <div id="result" class="page_div" style="display: none;">
        <div id="header" class="header">
            <h1>㏊ 결과를 확인하세요</h1>
        </div>
        <div id="main" class="main">
            <div id="result_div">
                <h2>결과</h2>
                <table id="result_table"></table>
            </div>
        </div>
        <div id="footer" class="footer">
            <div id="buttons_div" class="buttons_div">
                <button class="action_button _full" onclick="changePage()">다시하기</button>
                <!-- <button class="action_button _right" >공유</button> -->
            </div>
        </div>
    </div>
</body>
</html>
